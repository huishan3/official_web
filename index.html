<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Bean | 品味旋律，啜飲人生</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Three.js 庫 (保持 r128 版本，因為它將 THREE 暴露為全域變數) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- GSAP for smoother animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Define CSS Variables for consistent theming */
        :root {
            --color-bg: #fdfaf5; /* 溫暖米白 */
            --color-surface: #ffffff;
            --color-primary: #b58863; /* 柔和木質棕 */
            --color-secondary: #3f2e2e; /* 深咖啡文字 */
            --color-accent: #6b8e23; /* 橄欖綠 */
            --color-highlight: #fce5d8; /* 新增活潑亮點色：淺珊瑚或淺桃色 */
        }
        html {
            scroll-behavior: smooth; /* 平滑捲動 */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-secondary);
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            background-attachment: fixed;
            overflow-x: hidden; /* 防止水平滾動條 */
        }
        h1, h2, h3, h4, .font-serif {
            font-family: 'Playfair Display', serif;
        }
        /* 淡入上滑動畫 */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .fade-in-up.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* 卡片懸停效果 */
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-8px); /* 更明顯的提升 */
            box-shadow: 0 12px 30px rgba(0,0,0,0.15); /* 更強的陰影 */
        }
        /* 主要按鈕樣式 */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #a07654;
            transform: translateY(-2px); /* 懸停時輕微上浮 */
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        /* 次要按鈕樣式 */
        .btn-secondary {
            background-color: var(--color-secondary);
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover {
            background-color: #5a4444;
            transform: translateY(-2px); /* 懸停時輕微上浮 */
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        /* FAQ 手風琴樣式 */
        .accordion-button::after {
            content: '\f078'; /* Font Awesome 向下箭頭 */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            float: right;
            transition: transform 0.3s;
        }
        .accordion-button.open::after {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        /* 區塊標題顏色 */
        .section-title {
            color: var(--color-primary);
        }
        /* 錯誤訊息樣式 */
        .error-message {
            color: #ef4444; /* Tailwind 紅色-500 */
            text-align: center;
            padding: 1rem;
            border: 1px solid #fca5a5; /* Tailwind 紅色-300 */
            background-color: #fee2e2; /* Tailwind 紅色-100 */
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        /* 風味指南中咖啡豆詳細資訊的卡片樣式 */
        .card {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* 前台自訂訊息彈窗樣式 */
        .front-modal {
            display: flex; /* Always flex to center content */
            position: fixed; /* Keep in place */
            z-index: 1000; /* Topmost */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Slightly darker, more prominent overlay */
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease-out; /* For fade-in/out */
            opacity: 0; /* Initial state: hidden */
            pointer-events: none; /* Disable interaction when hidden */
        }
        .front-modal.active { /* Use 'active' class to show modal */
            opacity: 1;
            pointer-events: auto; /* Enable interaction when active */
        }
        .front-modal-content {
            background-color: var(--color-surface); /* Consistent with card background, slightly off-white */
            padding: 30px; /* More padding */
            border-radius: 16px; /* More rounded */
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); /* Stronger shadow */
            max-width: 450px; /* Slightly wider */
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9); /* Initial scale for pop-in effect */
            opacity: 0; /* Initial opacity for pop-in */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
        }
        .front-modal.active .front-modal-content {
            transform: scale(1); /* Scale up to normal size */
            opacity: 1; /* Fade in */
        }
        .front-modal-close-button {
            color: #888;
            font-size: 24px; /* Smaller icon */
            position: absolute;
            top: 15px;
            right: 18px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .front-modal-close-button:hover,
        .front-modal-close-button:focus {
            color: var(--color-secondary);
        }
        /* Icon styling for modal */
        #frontModalIcon { /* New icon container styling */
            font-size: 4rem; /* Large icon */
            margin-bottom: 1rem;
            line-height: 1; /* Ensure vertical alignment */
            display: flex; /* Allow content to center */
            justify-content: center;
            align-items: center;
            height: 4rem; /* Fixed height for consistency */
        }
        .icon-success { color: var(--color-accent); } /* Green */
        .icon-error { color: #ef4444; } /* Red */
        .icon-info { color: var(--color-primary); } /* Primary color for info */

        /* Title colors for modal based on type */
        .front-modal-success { color: var(--color-accent); }
        .front-modal-error { color: #ef4444; }
        .front-modal-info { color: var(--color-primary); }

        /* Modal Message Content with Scrolling */
        #frontModalMessage {
            max-height: 40vh; /* Adjust as needed, limit height */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 15px; /* Prevent scrollbar from overlapping text */
            margin-bottom: 1rem; /* Space before the button */
            flex-grow: 1; /* Allow it to grow and take available space */
            text-align: left; /* Align text to left inside the scrollable area */
            padding-left: 5px; /* Small left padding for text */
        }


        /* 庫存指示器樣式 */
        .stock-indicator {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
        }
        .stock-in-stock {
            background-color: #d1fae5; /* 綠色-100 */
            color: #065f46; /* 綠色-800 */
        }
        .stock-low-stock {
            background-color: #fef3c7; /* 黃色-100 */
            color: #92400e; /* 黃色-800 */
        }
        .stock-out-of-stock {
            background-color: #fee2e2; /* 紅色-100 */
            color: #991b1b; /* 紅色-800 */
        }

        /* 區塊標題脈衝動畫 */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.01); opacity: 0.95; }
        }
        /* Only apply pulse animation when 'is-pulsing' class is present */
        .section-title.animate-pulse-on-scroll.is-pulsing {
            animation: pulse 2s infinite ease-in-out;
        }
        /* Ensure it's not animating when not pulsing */
        .section-title.animate-pulse-on-scroll:not(.is-pulsing) {
            animation: none;
            opacity: 1; /* Ensure it stays visible */
            transform: scale(1); /* Ensure it stays normal size */
        }


        /* 首頁標題與段落動畫 */
        @keyframes fadeInSlideUp {
            0% { opacity: 0; transform: translateY(50px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        #home .relative.text-center.z-10 h1 { 
            animation: fadeInSlideUp 1.2s ease-out forwards;
            animation-delay: 0.5s;
        }
        #home .relative.text-center.z-10 p { 
            animation: fadeInSlideUp 1.2s ease-out forwards;
            animation-delay: 0.8s;
        }
        /* 確保這些元素在動畫運行前初始透明度為 0 */
        #home .relative.text-center.z-10 h1,
        #home .relative.text-center.z-10 p {
            opacity: 0; 
        }

        /* 圖片藝廊懸停效果及微妙旋轉 */
        .gallery-item img {
            transition: transform 0.3s ease-in-out;
        }
        .gallery-item:hover img {
            transform: scale(1.05) rotate(1deg); /* 增加輕微旋轉 */
        }

        /* 重新整理按鈕點擊時旋轉 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #refresh-coffee-btn i {
            animation: none; 
            transition: transform 0.3s ease-out;
        }
        #refresh-coffee-btn:active i { 
            animation: spin 0.6s linear;
        }
        
        /* 風味指南詳細資訊淡入 */
        #bean-details-display {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #bean-details-display.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- 粒子動畫 (咖啡豆 & 音符) --- */
        /* Three.js 咖啡豆粒子 */
        /* Three.js 咖啡豆粒子動畫 */
        /* 注意：此處的動畫效果由 GSAP 在 JS 中控制，CSS Keyframes 僅作備用或通用類別定義 */
        /* 對於 3D 粒子，GSAP 是首選，因為它可以直接操縱 Three.js 物件的屬性 */

        /* DOM 粒子（音符） */
        @keyframes floatAndFadeNote {
            0% { transform: translate(0, 0) scale(0.7); opacity: 0; }
            20% { opacity: 0.2; } /* 降低峰值透明度以增加細膩感 */
            80% { opacity: 0.15; } /* 降低結束透明度以增加細膩感 */
            100% { transform: translate(var(--x-end), var(--y-end)) scale(1.1); opacity: 0; }
        }

        @keyframes rotateParticle {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animated-particle {
            position: fixed; /* 相對於視窗定位 */
            font-size: 1.5rem; /* 基礎大小，會縮放 */
            opacity: 0;
            pointer-events: none; /* 不阻擋滑鼠事件 */
            user-select: none; /* 不允許文字選取 */
            z-index: 999; /* 確保粒子在內容上方，但低於模態框 */
        }

        /* 僅音符使用 DOM-based 動畫 */
        .animated-particle.musical-note {
            color: var(--color-highlight); /* 高亮色作為音符顏色 */
            animation: floatAndFadeNote var(--duration) ease-out forwards, rotateParticle var(--rotate-duration) linear infinite;
        }

        /* 返回頂部按鈕樣式 */
        #back-to-top-btn {
            display: none; /* 預設隱藏 */
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* 預設透明 */
            transform: translateY(10px); /* 預設稍微向下 */
        }

        #back-to-top-btn.show {
            opacity: 1;
            transform: translateY(0);
        }

        #back-to-top-btn:hover {
            background-color: #a07654;
            transform: translateY(-3px);
        }

        /* 導覽列活動連結樣式 */
        .nav-link.active-nav {
            font-weight: 700; /* 加粗 */
            color: var(--color-primary); /* 主要顏色 */
            border-bottom: 2px solid var(--color-primary); /* 下劃線 */
            padding-bottom: 4px; /* 與下劃線的間距 */
        }

        /* 沖泡動畫視覺效果 */
        #brewing-visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-surface); /* 覆蓋資訊區塊 */
            border-radius: 0.75rem; /* 配合父容器的圓角 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none; /* 確保不阻擋下方事件 */
            z-index: 20; /* 確保在其他內容之上 */
        }

        #brewing-visualizer.active {
            opacity: 1;
            pointer-events: auto;
        }

        .brewing-cup-container {
            position: relative;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: end;
            justify-content: center;
            overflow: hidden;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            border: 2px solid #ccc; /* 咖啡杯邊框 */
            background-color: #fefefe; /* 咖啡杯顏色 */
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
        }

        .brewing-liquid {
            width: 100%;
            background-color: var(--color-primary); /* 咖啡液顏色 */
            height: 0%;
            transition: height 1.5s ease-in-out; /* 咖啡液填充動畫 */
            border-radius: 0 0 50% 50% / 0 0 10% 10%; /* 頂部輕微弧度 */
        }

        .brewing-liquid.fill {
            height: 80% !important; /* 填充至 80% */
        }

        /* 咖啡小知識彈窗樣式 */
        #coffee-fact-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-secondary); /* 深色背景 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            text-align: center;
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            z-index: 998; /* 在返回頂部按鈕之下，但在模態框之下 */
            pointer-events: none; /* 預設不阻擋滑鼠事件 */
        }

        #coffee-fact-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto; /* 顯示時才允許互動 */
        }

        /* 首頁滾動提示按鈕 */
        #scroll-down-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: none;
            border: none;
            cursor: pointer;
            animation: bounce 2s infinite; /* 跳動動畫 */
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        #scroll-down-btn svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* 咖啡渣卡片翻轉效果 */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 250px; /* 固定高度，避免內容高度不一導致跳動 */
            perspective: 1000px; /* 3D 效果 */
            cursor: pointer;
            transition: transform 0.6s;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            overflow: hidden; /* Prevent content overflow during flip */
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: var(--color-surface);
        }

        .flip-card-back {
            background-color: var(--color-primary); /* 翻轉後的背景色 */
            color: white;
            transform: rotateY(180deg);
            padding: 1.5rem;
            text-align: left;
            font-size: 0.95rem;
        }
        .flip-card-back h4 {
            color: white; /* Make sure title is visible on dark background */
            margin-bottom: 0.5rem;
        }
        .flip-card-front img {
            max-height: 80px; /* Adjust icon size */
            margin-bottom: 0.75rem;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        /* 咖啡豆區塊的圖片懸停提示 */
        .bean-card {
            position: relative;
            overflow: hidden;
        }
        .bean-card .bean-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            padding: 1rem;
            border-radius: 0.75rem;
            backdrop-filter: blur(3px); /* 輕微模糊效果 */
        }
        .bean-card:hover .bean-overlay {
            opacity: 1;
        }

        /* Three.js canvas styling */
        #three-canvas {
            width: 100% !important; /* Take full width of its container */
            height: 100% !important; /* Take full height of its container */
            display: block; /* Remove extra space below canvas */
            background-color: transparent; /* Ensure canvas background is transparent */
            pointer-events: auto; /* 確保咖啡機可互動 */
        }

        /* 內容區域的調整，恢復全寬 */
        main {
            position: relative;
            z-index: 1; /* 確保內容在 Three.js 區域之上，如果 Three.js 容器本身有定位 */
            width: 100%; /* 內容區塊佔據全寬 */
            margin-left: 0; /* 移除左邊距 */
            overflow-x: hidden; /* 防止水平滾動 */
        }

        /* 各個 Section 確保足夠高以便滾動 */
        section {
            min-height: 100vh; /* 確保每個區塊足夠高 */
            display: flex;
            flex-direction: column;
            justify-content: center; /* 內容垂直居中 */
            padding: 4rem 2rem; /* 增加內邊距 */
            box-sizing: border-box;
            background-color: var(--color-bg); /* 各自背景色 */
            border-bottom: 1px solid rgba(0,0,0,0.05); /* 輕微分隔線 */
        }
        /* 調整 Home Section，使其內容在視覺上不會被咖啡機遮擋 */
        #home {
            position: relative;
            z-index: 2; /* 確保在載入時覆蓋 Three.js */
            padding-bottom: 4rem; /* Adjust padding as the machine is no longer "below" it visually */
        }

        /* 導航欄的調整，確保在 Three.3 之上 */
        nav {
            position: sticky;
            top: 0;
            z-index: 100; /* 導航欄置頂 */
        }

        /* 沖泡模擬按鈕樣式 */
        .brew-step-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Fully rounded */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            margin: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none; /* Remove default button border */
        }

        .brew-step-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        .brew-step-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Specific colors for brewing buttons */
        #btn-add-beans {
            background-color: #8B4513; /* Saddle Brown */
            color: white;
        }
        #btn-add-beans:hover {
            background-color: #6F4E37; /* Darker Brown */
        }

        #btn-start-grinding {
            background-color: #D2B48C; /* Tan */
            color: var(--color-secondary);
        }
        #btn-start-grinding:hover {
            background-color: #C0A07C; /* Darker Tan */
        }

        #btn-start-brewing {
            background-color: var(--color-primary); /* Primary color */
            color: white;
        }
        #btn-start-brewing:hover {
            background-color: #a07654;
        }

        #btn-reset-machine {
            background-color: #F3F4F6; /* Gray-100 */
            color: var(--color-secondary);
            border: 1px solid #D1D5DB; /* Gray-300 */
        }
        #btn-reset-machine:hover {
            background-color: #E5E7EB; /* Gray-200 */
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="text-xl text-secondary">正在為您準備香醇的咖啡體驗...</p>
    </div>

    <nav class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
            <a href="#home" class="text-3xl font-serif text-secondary">Melody Bean</a>
            <div class="hidden md:flex items-center space-x-6 text-lg">
                <a href="#flavor-guide" class="hover:text-primary transition-colors nav-link">風味探索</a>
                <a href="#our-beans" class="hover:text-primary transition-colors nav-link">精選咖啡豆</a>
                <a href="#coffee-grounds-magic" class="hover:text-primary transition-colors nav-link">咖啡渣魔法</a>
                <a href="#story" class="hover:text-primary transition-colors nav-link">我們的故事</a>
                <a href="#knowledge" class="hover:text-primary transition-colors nav-link">咖啡知識</a>
                <a href="#image-gallery" class="hover:text-primary transition-colors nav-link">咖啡藝廊</a>
                <a href="#faq" class="hover:text-primary transition-colors nav-link">常見問題</a>
                <a href="#contact" class="px-4 py-2 rounded-full btn-primary nav-link">聯絡我們</a>
            </div>
            </div>
    </nav>

    <main>
        <!-- Home Section -->
        <section id="home" class="h-screen bg-cover bg-center flex items-center justify-center text-white relative overflow-hidden" style="background-image: url('image/image_2.jpg');">
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="relative text-center z-10 p-6">
                <h1 class="text-5xl md:text-7xl font-serif mb-4 text-shadow-soft">品味旋律，啜飲人生</h1>
                <p class="text-xl md:text-2xl max-w-2xl mx-auto">在 Melody Bean，每一顆咖啡豆都承載著一段故事與一首旋律，我們邀請您一同放慢腳步，感受生活中的溫暖與美好。</p>
            </div>
            <button id="scroll-down-btn" aria-label="向下滾動">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21L4 13H10V3H14V13H20L12 21Z" />
                </svg>
            </button>
        </section>

        <!-- NEW SECTION: Coffee Machine Display with Simulation Controls -->
        <section id="coffee-machine-display" class="py-10 bg-white/50 relative overflow-hidden flex flex-col items-center justify-center">
            <div class="fade-in-up text-center mb-8">
                <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">咖啡沖泡模擬體驗</h2>
                <p class="mt-4 text-lg text-gray-600">點擊下方按鈕，一步步體驗從咖啡豆到一杯香醇咖啡的奇妙過程！</p>
            </div>
            <div id="threejs-container" class="fade-in-up" style="transition-delay: 200ms;">
                <canvas id="three-canvas"></canvas>
            </div>
            <div class="mt-8 flex flex-wrap justify-center items-center fade-in-up" style="transition-delay: 400ms;">
                <button id="btn-add-beans" class="brew-step-button">
                    <i class="fas fa-coffee-bean mr-2"></i> 投入咖啡豆
                </button>
                <button id="btn-start-grinding" class="brew-step-button" disabled>
                    <i class="fas fa-grinder mr-2"></i> 開始研磨
                </button>
                <button id="btn-start-brewing" class="brew-step-button" disabled>
                    <i class="fas fa-mug-hot mr-2"></i> 開始沖泡
                </button>
                <button id="btn-reset-machine" class="brew-step-button">
                    <i class="fas fa-undo-alt mr-2"></i> 清除
                </button>
            </div>
        </section>

        <section id="flavor-guide" class="py-20 bg-white/50 relative overflow-hidden">
            <div class="max-w-6xl mx-auto px-6 text-center">
                <div class="fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">風味探索指南</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">不知道如何選擇？讓我們為您視覺化每一款咖啡的獨特個性。</p>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-8 fade-in-up">
                    <div class="w-full">
                        <label for="flavor-select" class="block text-left mb-2 font-semibold">選擇一款咖啡豆來查看風味圖譜：</label>
                        <select id="flavor-select" class="w-full p-3 border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                            </select>
                        <div id="lifestyle-suggestion" class="mt-6 text-left p-4 bg-green-50 rounded-lg border border-accent text-gray-700">
                            <h4 class="font-bold font-serif text-lg text-accent mb-2">生活提案</h4>
                            <p>請先選擇一款咖啡豆，我們會為您推薦最適合的品飲時刻與搭配。</p>
                        </div>
                        <div id="bean-details-display" class="mt-6 text-left p-4 bg-blue-50 rounded-lg border border-blue-300 text-gray-700 relative overflow-hidden" style="min-height: 280px;">
                            <!-- 沖泡動畫容器 -->
                            <div id="brewing-visualizer">
                                <div class="brewing-cup-container">
                                    <div class="brewing-liquid"></div>
                                </div>
                                <p class="mt-4 text-gray-700 text-sm">正在為您沖泡這款咖啡...</p>
                            </div>
                            <!-- 實際的詳細資訊內容 -->
                            <h4 class="font-bold font-serif text-lg text-blue-700 mb-2">品項詳細資訊</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <p><span class="font-semibold">名稱:</span> <span id="detail-name"></span></p>
                                <p><span class="font-semibold">國家:</span> <span id="detail-country"></span></p>
                                <p><span class="font-semibold">品種:</span> <span id="detail-variety"></span></p>
                                <p><span class="font-semibold">烘焙度:</span> <span id="detail-roast"></span></p>
                                <p><span class="font-semibold">重量:</span> <span id="detail-weight"></span></p>
                                <p><span class="font-semibold">期限:</span> <span id="detail-expiry"></span></p>
                                <p class="col-span-2"><span class="font-semibold">風味:</span> <span id="detail-flavor"></span></p>
                                <p class="col-span-2"><span class="font-semibold">庫存:</span> <span id="detail-stock"></span> <span id="stock-status" class="stock-indicator"></span></p>
                                <p class="col-span-2 text-lg font-bold text-primary">售價: NT$<span id="detail-price"></span></p>
                            </div>
                        </div>
                        <div class="mt-10 flex flex-col sm:flex-row justify-center items-center gap-4">
                            <button id="refresh-coffee-btn" class="px-8 py-3 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors inline-block">
                                <i class="fas fa-sync-alt mr-2"></i> 重新整理咖啡豆資訊
                            </button>
                        </div>
                    </div>
                    <div class="w-full hidden md:block">
                        <canvas id="flavorRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW SECTION: Our Premium Coffee Beans -->
        <section id="our-beans" class="py-20 relative overflow-hidden">
            <div class="max-w-6xl mx-auto px-6 text-center">
                <div class="fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">我們的精選咖啡豆</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">來自世界各地的精品咖啡豆，每一顆都蘊含著獨特的故事與風味。</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card p-4 fade-in-up bean-card">
                        <img src="image/image_1.png" alt="黃金曼特寧" class="w-full h-48 object-cover rounded-md mb-4">
                        <div class="bean-overlay">
                            <p>黃金曼特寧：醇厚濃郁，帶有巧克力和堅果香氣，是經典中的經典。</p>
                        </div>
                        <h3 class="text-xl font-serif mb-2">黃金曼特寧</h3>
                        <p class="text-gray-600 text-sm">風味：黑巧克力、焦糖、低酸度</p>
                    </div>
                    <div class="card p-4 fade-in-up bean-card" style="transition-delay: 100ms;">
                        <img src="image/image_2.png" alt="衣索比亞 耶加雪菲" class="w-full h-48 object-cover rounded-md mb-4">
                        <div class="bean-overlay">
                            <p>耶加雪菲：花香、柑橘與莓果的清新結合，口感明亮活潑。</p>
                        </div>
                        <h3 class="text-xl font-serif mb-2">衣索比亞 耶加雪菲</h3>
                        <p class="text-gray-600 text-sm">風味：茉莉花、檸檬、佛手柑</p>
                    </div>
                    <div class="card p-4 fade-in-up bean-card" style="transition-delay: 200ms;">
                        <div class="bean-overlay">
                            <p>哥倫比亞 薇拉：平衡的甜感，帶有核果與巧克力的尾韻，口感順滑。</p>
                        </div>
                        <img src="image/image_3.png" alt="哥倫比亞 薇拉" class="w-full h-48 object-cover rounded-md mb-4">
                        <h3 class="text-xl font-serif mb-2">哥倫比亞 薇拉</h3>
                        <p class="text-gray-600 text-sm">風味：核桃、可可、焦糖</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW SECTION: The Magic of Coffee Grounds -->
        <section id="coffee-grounds-magic" class="py-20 bg-white/50 relative overflow-hidden">
            <div class="max-w-6xl mx-auto px-6 text-center">
                <div class="fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">咖啡渣的魔法</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">別急著丟棄！用過的咖啡渣，其實是生活中的環保寶藏。</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="flip-card fade-in-up">
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <img src="https://placehold.co/60x60/e0e0e0/3f2e2e?text=肥料" alt="天然植物肥料" class="mb-4">
                                <h3 class="text-xl font-serif mb-2">天然植物肥料</h3>
                                <p class="text-gray-600 text-sm">富含氮、磷、鉀，讓您的植物枝繁葉茂。</p>
                            </div>
                            <div class="flip-card-back">
                                <h4 class="font-bold text-lg">DIY 植物肥料</h4>
                                <p>將乾燥的咖啡渣直接混入盆栽土壤中，或與廚餘堆肥一同發酵，為植物提供天然養分。特別適合喜酸性土壤的植物，如杜鵑、繡球花。</p>
                            </div>
                        </div>
                    </div>
                    <div class="flip-card fade-in-up" style="transition-delay: 100ms;">
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <img src="https://placehold.co/60x60/e0e0e0/3f2e2e?text=除臭" alt="天然除臭劑" class="mb-4">
                                <h3 class="text-xl font-serif mb-2">天然除臭劑</h3>
                                <p class="text-gray-600 text-sm">吸附異味，讓冰箱、鞋櫃恢復清新。</p>
                            </div>
                            <div class="flip-card-back">
                                <h4 class="font-bold text-lg">製作除臭包</h4>
                                <p>將乾燥咖啡渣裝入透氣小袋或網襪中，放置於冰箱、鞋櫃、衣櫥或煙灰缸，有效吸附濕氣與異味。定期更換以保持效果。</p>
                            </div>
                        </div>
                    </div>
                    <div class="flip-card fade-in-up" style="transition-delay: 200ms;">
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <img src="https://placehold.co/60x60/e0e0e0/3f2e2e?text=去角質" alt="身體去角質" class="mb-4">
                                <h3 class="text-xl font-serif mb-2">溫和身體去角質</h3>
                                <p class="text-gray-600 text-sm">天然顆粒溫和去除老廢角質，還您柔滑肌膚。</p>
                            </div>
                            <div class="flip-card-back">
                                <h4 class="font-bold text-lg">DIY 咖啡渣磨砂膏</h4>
                                <p>將乾燥咖啡渣與少量橄欖油或椰子油混合，加入少許蜂蜜（可選），輕輕按摩身體肌膚後沖洗。咖啡因也有助於緊緻肌膚。敏感肌膚請謹慎使用。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="story" class="py-20 relative overflow-hidden">
            <div class="max-w-4xl mx-auto px-6">
                <div class="text-center mb-12 fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">我們的故事</h2>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg fade-in-up">
                    <h3 class="text-2xl font-serif text-secondary mb-4">從樂音到咖啡香，始於一份純粹的熱愛</h3>
                    <div class="text-gray-700 leading-relaxed">
                        <div class="mb-4"> 23 年前的今天，樂海樂器正式開幕，那是我們對聲音藝術的初心。一路走來，我們陪伴無數樂友選琴、修琴，更一起分享著對美好樂音的熱愛與執著。</div>
                        <div class="mb-4">☕ 2021 年，一場突如其來的疫情三級警戒，讓我心中湧現了不安。就在那段幾乎與世隔絕的日子裡，我卻意外地一頭栽進了咖啡烘焙的奇妙世界。咖啡的醇厚香氣，彷彿成了另一種心靈的安定劑與創意的泉源。</div>
                        <div class="mb-4">2024 年，我榮幸地參加烘豆比賽並獲得獎項，這份肯定更加堅定了我走上「雙品牌職人之路」的決心。從揚琴工坊的精湛細膩手工，到精品咖啡豆的精準火候掌控，我始終堅信——聲音與風味，都是值得我們傾注心血、用心雕琢的藝術。</div>
                    </div>
                    <!-- START: Local Video Integration (Updated from YouTube Embed) -->
                    <div class="mt-8 text-center">
                        <h4 class="text-2xl font-serif text-secondary mb-4">我們的品牌故事影片</h4>
                        <div class="relative w-full overflow-hidden rounded-lg shadow-xl" style="padding-top: 56.25%;"> <!-- 16:9 Aspect Ratio for responsive video -->
                            <video
                                class="absolute top-0 left-0 w-full h-full rounded-lg"
                                controls
                                autoplay
                                muted
                                loop
                                playsinline> <!-- playsinline for iOS autoplay -->
                                <source src="./video/video_1.mp4" type="video/mp4">
                                您的瀏覽器不支持影片標籤。
                            </video>
                        </div>
                    </div>
                    <!-- END: Local Video Integration -->
                </div>
                <div class="mt-16 text-center fade-in-up">
                    <h3 class="text-3xl font-serif section-title animate-pulse-on-scroll mb-8">幕後職人</h3>
                    <div class="card p-8 flex flex-col md:flex-row items-center gap-8">
                        <!-- Updated image path for "咖啡職人" -->
                        <img src="image/image_3.jpg" alt="咖啡職人" class="w-36 h-36 rounded-full object-cover">
                        <div class="text-left">
                            <h4 class="text-2xl font-serif text-secondary">創辦人 / 首席烘豆師</h4>
                            <p class="text-lg text-primary mt-1">陳師傅</p>
                            <p class="mt-4 text-gray-600">擁有超過20年的樂器製作工藝背景，將對精準與和諧的追求，完美轉化為對咖啡烘焙的熱情。對他而言，每一條烘焙曲線，都像是在譜寫一首動人的樂曲。</p>
                            <p class="mt-2 text-gray-700">由陳師傅親自烘培，確保每一顆豆子都能展現其最佳風味。</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="knowledge" class="py-20 bg-white/50 relative overflow-hidden">
            <div class="max-w-6xl mx-auto px-6">
                <div class="text-center mb-12 fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">線上咖啡小學堂</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">一些關於咖啡的趣聞與知識，希望能豐富您的咖啡生活。</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="card p-6 fade-in-up group">
                        <h3 class="text-xl font-serif mb-2 group-hover:text-primary transition-colors">手沖咖啡新手入門</h3>
                        <p class="text-gray-600">想在家享受一杯完美的手沖咖啡嗎？從磨豆、水溫到注水技巧，我們為您整理了幾個關鍵步驟，讓您輕鬆上手。</p>
                        <a href="javascript:void(0);" class="text-primary hover:underline mt-4 inline-block more-info-link" data-knowledge-id="1">閱讀更多 <i class="fas fa-arrow-right ml-1"></i></a>
                    </div>
                    <div class="card p-6 fade-in-up group" style="transition-delay: 100ms;">
                        <h3 class="text-xl font-serif mb-2 group-hover:text-primary transition-colors">如何保存咖啡豆？</h3>
                        <p class="text-gray-600">咖啡豆是嬌貴的農產品。避免光線、空氣、濕氣和高溫是保持其新鮮風味的不二法門。建議使用密封罐存放在陰涼處。根據不同的烘焙程度，咖啡豆可以保存數週到數月。</p>
                        <a href="javascript:void(0);" class="text-primary hover:underline mt-4 inline-block more-info-link" data-knowledge-id="2">閱讀更多 <i class="fas fa-arrow-right ml-1"></i></a>
                    </div>
                    <div class="card p-6 fade-in-up group" style="transition-delay: 200ms;">
                        <h3 class="text-xl font-serif mb-2 group-hover:text-primary transition-colors">音樂與咖啡的完美結合</h3>
                        <p class="text-gray-600">您知道嗎？聆聽不同類型的音樂，可能會影響您對咖啡風味的感受。下次品嚐時，不妨試著搭配一首古典樂或爵士樂吧！</p>
                        <a href="javascript:void(0);" class="text-primary hover:underline mt-4 inline-block more-info-link" data-knowledge-id="3">閱讀更多 <i class="fas fa-arrow-right ml-1"></i></a>
                    </div>
                </div>
            </div>
        </section>

        <!-- NEW SECTION: Image Gallery -->
        <section id="image-gallery" class="py-20 bg-white/50 relative overflow-hidden">
            <div class="max-w-6xl mx-auto px-6 text-center">
                <div class="fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">咖啡藝廊：視覺饗宴</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">透過鏡頭，探索咖啡與生活的各種美好瞬間。</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Images will be rendered here -->
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_1.png" alt="咖啡師沖泡咖啡" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">細緻的拉花藝術</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_2.png" alt="咖啡豆近景" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">新鮮烘焙的咖啡豆</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_3.png" alt="陽光下的咖啡杯" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">午後的咖啡時光</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_4.png" alt="咖啡器具展示" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">精緻的咖啡器具</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_5.png" alt="手沖咖啡過程" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">專注的手沖藝術</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_6.png" alt="咖啡與書籍" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">閱讀與咖啡的絕配</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_7.png" alt="咖啡店內景" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">Melody Bean 溫馨一隅</p>
                        </div>
                    </div>
                    <div class="rounded-lg overflow-hidden shadow-md group gallery-item">
                        <img src="image/image_8.png" alt="咖啡農場風景" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="p-4 bg-white text-left">
                            <p class="text-gray-700 font-semibold">咖啡豆的產地風光</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="faq" class="py-20 relative overflow-hidden">
            <div class="max-w-4xl mx-auto px-6">
                <div class="text-center mb-12 fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">常見問題</h2>
                </div>
                <div class="space-y-4">
                    <div class="card p-6 fade-in-up">
                        <button class="accordion-button flex justify-between items-center w-full text-left font-semibold text-xl text-secondary" aria-expanded="false">
                            <span class="mr-2">Melody Bean 的咖啡豆來源為何？</span>
                        </button>
                        <div class="accordion-content mt-4 text-gray-700">
                            我們的咖啡豆均來自全球知名的咖啡產區，並與當地優質莊園直接合作，確保每一顆豆子的品質與風味都達到最佳水準。
                        </div>
                    </div>
                    <div class="card p-6 fade-in-up" style="transition-delay: 100ms;">
                        <button class="accordion-button flex justify-between items-center w-full text-left font-semibold text-xl text-secondary" aria-expanded="false">
                            <span class="mr-2">如何確保咖啡豆的新鮮度？</span>
                        </button>
                        <div class="accordion-content mt-4 text-gray-700">
                            Melody Bean 採小批量新鮮烘焙，並在烘焙完成後立即使用單向排氣閥包裝，最大限度地保留咖啡豆的香氣與新鮮度。我們建議您在收到咖啡豆後的兩週內享用，以體驗最佳風味。
                        </div>
                    </div>
                    <div class="card p-6 fade-in-up" style="transition-delay: 200ms;">
                        <button class="accordion-button flex justify-between items-center w-full text-left font-semibold text-xl text-secondary" aria-expanded="false">
                            <span class="mr-2">咖啡渣還有什麼其他用途？</span>
                        </button>
                        <div class="accordion-content mt-4 text-gray-700">
                            咖啡渣是天然的除臭劑，可用於冰箱、鞋櫃。它也是優良的植物肥料，富含氮，能幫助植物生長。此外，乾燥的咖啡渣也可以用於製作身體去角質磨砂膏。
                        </div>
                    </div>
                    <div class="card p-6 fade-in-up" style="transition-delay: 300ms;">
                        <button class="accordion-button flex justify-between items-center w-full text-left font-semibold text-xl text-secondary" aria-expanded="false">
                            <span class="mr-2">是否提供客製化烘焙服務？</span>
                        </button>
                        <div class="accordion-content mt-4 text-gray-700">
                            目前我們主要提供精選烘焙度的咖啡豆。若您有特殊需求或大宗採購，歡迎透過聯絡我們頁面與我們聯繫，我們將樂意為您提供客製化諮詢服務。
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="contact" class="py-20 bg-white/50 relative overflow-hidden">
            <div class="max-w-4xl mx-auto px-6 text-center">
                <div class="fade-in-up">
                    <h2 class="text-4xl font-serif section-title animate-pulse-on-scroll">聯絡我們</h2>
                    <p class="mt-4 text-lg text-gray-600 mb-8">有任何問題或建議？歡迎隨時與我們聯繫！</p>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg text-left fade-in-up">
                    <form id="contact-form" class="space-y-6" action="" method="post" enctype="text/plain">
                        <div>
                            <label for="name" class="block text-lg font-medium text-gray-700 mb-2">您的姓名</label>
                            <input type="text" id="name" name="姓名" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="email" class="block text-lg font-medium text-gray-700 mb-2">您的電子郵件</label>
                            <input type="email" id="email" name="電子郵件" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="message" class="block text-lg font-medium text-gray-700 mb-2">您的訊息</label>
                            <textarea id="message" name="訊息" rows="5" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"></textarea>
                        </div>
                        <button type="submit" class="btn-primary w-full py-3 rounded-md text-lg">發送訊息</button>
                    </form>
                </div>
                <div class="mt-12 text-center text-gray-600 fade-in-up">
                    <p class="text-xl mb-2">或直接聯絡我們：</p>
                    <p class="text-2xl font-bold text-primary mb-2"><i class="fas fa-phone mr-2"></i> (03) 4081932</p>
                    <p class="text-xl"><i class="fas fa-envelope mr-2"></i> melodybean33427@gmail.com</p>
                    <p class="text-xl mt-4"><i class="fas fa-map-marker-alt mr-2"></i> 桃園市中壢區中正路4段141號</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-secondary text-white py-8">
        <div class="max-w-6xl mx-auto px-6 text-center text-gray-300">
            <p>&copy; 2024 Melody Bean. All rights reserved.</p>
            <div class="flex justify-center space-x-6 mt-4 text-2xl">
                <a href="#" class="hover:text-primary transition-colors"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="hover:text-primary transition-colors"><i class="fab fa-instagram"></i></a>
                <a href="#" class="hover:text-primary transition-colors"><i class="fab fa-line"></i></a>
            </div>
            <p class="mt-4 text-sm">品味旋律，啜飲人生。</p>
        </div>
    </footer>

    <!-- 自定義訊息彈窗 -->
    <div id="frontMessageModal" class="front-modal">
        <div class="front-modal-content">
            <span class="front-modal-close-button" onclick="closeFrontMessageModal()">&times;</span>
            <div id="frontModalIcon"></div>
            <h3 id="frontModalTitle" class="text-2xl font-serif mb-4"></h3>
            <p id="frontModalMessage" class="text-gray-700 mb-4"></p>
            <button onclick="closeFrontMessageModal()" class="btn-primary px-6 py-2 rounded-full mx-auto">確認</button>
        </div>
    </div>

    <!-- 返回頂部按鈕 -->
    <button id="back-to-top-btn" aria-label="返回頂部">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- 咖啡小知識彈窗 -->
    <div id="coffee-fact-toast" class="px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- Three.js 互動回饋彈窗 -->
    <div id="three-js-feedback-toast" class="px-6 py-3 rounded-lg shadow-lg">
        <p id="three-toast-message"></p>
    </div>

    <!-- 將主 JavaScript 區塊的 type="module" 移除，以確保 THREE 能夠全域存取 -->
    <script>
        // IIFE for encapsulation
        (function() {
            // Firebase SDKs for Frontend (Reading data)
            // These imports are now inside the IIFE and scoped locally
            // This means window.firebaseApp, window.db, window.auth etc. need to be handled carefully
            // Re-adding the module import for Firebase here as it was removed in previous step,
            // but it's needed for Firestore operations.
            // However, to make THREE.js global, the main script block should not be type="module".
            // Let's adjust the Firebase initialization to be within the DOMContentLoaded and ensure globals are set.
            // This is a tricky balance. The previous version with `window.` prefix was correct for non-module script.
            // Let's revert the Firebase import to be outside the IIFE but still in a module script,
            // and ensure the main script is NOT a module.

            // Frontend-specific data (knowledge articles and gallery images)
            // This flavorData is now replaced by Firestore data in the updated logic.
            // Keeping it here as a fallback or for other uses if needed, but the main product display will use Firestore.
            const knowledgeArticles = {
                1: {
                    title: "手沖咖啡新手入門：五大關鍵步驟",
                    content: `
                        <p>手沖咖啡是一門藝術，也是一種享受。以下是五個關鍵步驟，幫助您在家也能沖出香醇好咖啡：</p>
                        <ol class="list-decimal list-inside ml-4 mt-2 space-y-2">
                            <li><strong>準備器具：</strong>手沖壺、濾杯、濾紙、磨豆機、電子秤、計時器、咖啡杯。</li>
                            <li><strong>水溫控制：：</strong>建議水溫介於 88°C 至 92°C 之間，視咖啡豆烘焙程度調整。淺焙豆適合高溫，深焙豆適合稍低溫。</li>
                            <li><strong>黃金比例：</strong>咖啡粉與水的比例通常為 1:15 到 1:18。例如，15克咖啡粉搭配 225-270毫升水。</li>
                            <li><strong>悶蒸：</strong>將咖啡粉倒入濾杯，輕輕搖勻。第一次注水時，水量約為咖啡粉的兩倍（例如15克咖啡粉注入30毫升水），均勻潤濕所有咖啡粉，等待 20-30 秒，讓咖啡粉膨脹。這是釋放二氧化碳、提升風味的關鍵步驟。</li>
                            <li><strong>分段注水：</strong>悶蒸後，分 2-3 次緩慢、穩定地以畫圓方式注水，避免直接沖擊濾紙壁。每次注水之間可稍作停頓，等待水位下降。總沖泡時間控制在 2-3 分鐘內。</li>
                        </ol>
                        <p class="mt-4">多加練習，您會發現手沖咖啡的無限樂趣！</p>
                    `
                },
                2: {
                    title: "咖啡豆的完美保存指南",
                    content: `
                        <p>正確保存咖啡豆是維持其新鮮風味的關鍵。咖啡豆最大的敵人是：<strong>光線、空氣、濕氣、高溫</strong>。</p>
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-2">
                            <li><strong>密封容器：</strong>使用不透光、密封性良好的咖啡豆罐或帶有單向排氣閥的包裝袋。單向排氣閥能讓咖啡豆排出的二氧化碳逸出，同時阻擋外界空氣進入。</li>
                            <li><strong>避光：：</strong>將咖啡豆存放在陰涼、乾燥且避光的地方，例如櫥櫃內，避免陽光直射。</li>
                            <li><strong>避免潮濕：</strong>濕氣會加速咖啡豆變質。切勿將咖啡豆存放在潮濕的環境，如水槽旁或冰箱冷藏室（除非是真空包裝且確定不會頻繁取出導致溫差凝結水珠）。</li>
                            <li><strong>適宜溫度：</strong>室溫存放即可，避免高溫環境，如爐具旁。若想長期保存未開封的咖啡豆，可考慮冷凍，但務必使用真空密封包裝，且取出後一次用完，避免重複解凍。</li>
                            <li><strong>研磨後儘快沖泡：：</strong>咖啡豆一旦研磨成粉，接觸空氣的面積會大幅增加，風味流失速度加快。建議喝多少磨多少，享受最新鮮的風味。</li>
                        </ul>
                        <p class="mt-4">遵循這些小撇步，讓您的每一杯咖啡都保有最佳風味！</p>
                    `
                },
                3: {
                    title: "音樂與咖啡：一場感官的交響曲",
                    content: `
                        <p>您是否曾注意到，在某些咖啡館裡，特定的背景音樂總能讓咖啡喝起來特別美味？這並非偶然！科學研究表明，音樂確實可以影響我們對味覺的感知。</p>
                        <h4 class="font-semibold mt-4 mb-2">音樂如何影響咖啡體驗：</h4>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li><strong>情緒引導：</strong>輕柔、舒緩的音樂，如古典樂或輕爵士，能營造放鬆的氛圍，讓您更能細細品味咖啡的細膩層次。</li>
                            <li><strong>風味聯想：：</strong>某些音樂的節奏、音高和音色，可能與咖啡的特定風味特徵產生聯想。例如，高音調的音樂可能讓您感覺到咖啡的酸質更明亮，而低沉的音符則可能增強其醇厚度。</li>
                            <li><strong>分散注意力：：</strong>適當的背景音樂可以分散對環境噪音的注意力，讓您的味覺和嗅覺感官更專注於咖啡本身。</li>
                        </ul>
                        <h4 class="font-semibold mt-4 mb-2">推薦搭配：</h4>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li><strong>濃郁醇厚型咖啡（如曼特寧、義式濃縮）：</strong>搭配藍調、爵士樂或靈魂樂，讓其豐富的層次感更加突出。</li>
                            <li><strong>清新明亮型咖啡（如耶加雪菲、肯亞）：</strong>搭配輕快、高頻的音樂，如古典小品、Chill-hop 或輕柔的流行音樂，襯托其花果香氣。</li>
                            <li><strong>平衡感佳的咖啡（如哥倫比亞、巴西）：：</strong>各種音樂類型都能適配，您可以根據心情自由選擇。</li>
                        </ul>
                        <p class="mt-4">下次品嚐咖啡時，不妨打開您的專屬歌單，讓音樂與咖啡共同為您帶來一場難忘的感官體驗吧！</p>
                    `
                }
            };

            const galleryImages = [
                "image/image_1.png",
                "image/image_2.png",
                "image/image_3.png",
                "image/image_4.png",
                "image/image_5.png",
                "image/image_6.png",
                "image/image_7.png",
                "image/image_8.png"
            ];
            
            // Function to show custom front-end modal messages
            window.showFrontMessageModal = function(title, message, type = 'info') {
                const modal = document.getElementById('frontMessageModal');
                const modalTitle = document.getElementById('frontModalTitle');
                const modalMessage = document.getElementById('frontModalMessage');
                const modalIcon = document.getElementById('frontModalIcon');

                // Reset classes
                modalTitle.className = 'text-2xl font-serif mb-4';
                modalIcon.className = ''; 

                modalTitle.textContent = title;
                modalMessage.innerHTML = message; // Use innerHTML to allow for basic HTML tags if needed

                // Set icon and title color based on type
                switch (type) {
                    case 'success':
                        modalIcon.innerHTML = '<i class="fas fa-check-circle icon-success"></i>';
                        modalTitle.classList.add('front-modal-success');
                        break;
                    case 'error':
                        modalIcon.innerHTML = '<i class="fas fa-times-circle icon-error"></i>';
                        modalTitle.classList.add('front-modal-error');
                        break;
                    case 'info':
                    default:
                        modalIcon.innerHTML = '<i class="fas fa-info-circle icon-info"></i>';
                        modalTitle.classList.add('front-modal-info');
                        break;
                }
                modal.classList.add('active'); // Show modal
            };

            window.closeFrontMessageModal = function() {
                document.getElementById('frontMessageModal').classList.remove('active');
            };

            // Three.js Scene, Camera, Renderer, and Objects
            let scene, camera, renderer, coffeeMachine;
            // References to individual mesh parts for animation
            let hopperMesh, grinderMesh, filterStationMesh, cupMesh, spoutMesh; /* Added spoutMesh */
            let liquidStreamMesh; /* Added liquidStreamMesh */
            let liquidStreamGeometry; /* Declare liquidStreamGeometry at a higher scope */

            let currentBrewStep = 0; // 0: Idle, 1: Beans Added, 2: Grinding, 3: Brewing
            let liquidMesh; // To control the coffee liquid level
            let activeParticles = []; // Store active particle meshes for removal

            // Particle System Configuration
            const MUSICAL_NOTES_EMOJI = '🎶';
            const PARTICLE_LIFESPAN = 3000; // milliseconds for DOM particles

            // Function to create and animate a 3D particle (THREE.Mesh based)
            function createThreeJSParticle(type, worldPosition) {
                let geometry;
                let material;
                let particleMesh;

                if (type === 'coffee_bean') {
                    geometry = new THREE.SphereGeometry(0.08, 8, 8); // Small sphere for bean
                    material = new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.7, metalness: 0.1 }); // Dark brown
                    particleMesh = new THREE.Mesh(geometry, material);
                    // Random initial rotation for variety
                    particleMesh.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);

                    // Animate falling effect
                    gsap.to(particleMesh.position, {
                        y: worldPosition.y - Math.random() * 2 - 1, // Fall downwards
                        x: worldPosition.x + (Math.random() - 0.5) * 0.5,
                        z: worldPosition.z + (Math.random() - 0.5) * 0.5,
                        duration: Math.random() * 1.5 + 1.0, // 1 to 2.5 seconds
                        ease: "power1.in",
                        onComplete: () => {
                            if (particleMesh.parent) scene.remove(particleMesh); // Ensure it's still in scene before removing
                            activeParticles = activeParticles.filter(p => p !== particleMesh); // Corrected array name
                        }
                    });
                    // Optional: animate rotation during fall
                    gsap.to(particleMesh.rotation, {
                        x: "+=" + Math.PI * 4,
                        y: "+=" + Math.PI * 4,
                        duration: Math.random() * 1.5 + 1.0,
                        ease: "linear"
                    });

                } else if (type === 'coffee_powder') {
                    geometry = new THREE.SphereGeometry(0.02, 4, 4); // Very small, simpler sphere for powder
                    material = new THREE.MeshStandardMaterial({ color: 0x6F4E37, roughness: 0.9, metalness: 0.0, transparent: true, opacity: 1.0 }); // Lighter brown/tan
                    particleMesh = new THREE.Mesh(geometry, material);
                    
                    // Animate floating/spreading effect
                    gsap.to(particleMesh.position, {
                        y: worldPosition.y - Math.random() * 0.5 - 0.2, // Slightly downwards or sideways
                        x: worldPosition.x + (Math.random() - 0.5) * 0.3,
                        z: worldPosition.z + (Math.random() - 0.5) * 0.3,
                        duration: Math.random() * 0.8 + 0.5, // 0.5 to 1.3 seconds
                        ease: "power1.out",
                        onComplete: () => {
                            if (particleMesh.parent) scene.remove(particleMesh);
                            activeParticles = activeParticles.filter(p => p !== particleMesh); // Corrected array name
                        }
                    });
                    gsap.to(particleMesh.material, {
                        opacity: 0,
                        duration: Math.random() * 0.8 + 0.5,
                        ease: "power1.out"
                    });

                } else {
                    console.warn("Unhandled 3D particle type provided to createThreeJSParticle. No 3D particle created.");
                    return null; 
                }

                particleMesh.position.copy(worldPosition);
                scene.add(particleMesh);
                activeParticles.push(particleMesh); // Add to tracking for removal if needed (Corrected array name)
                return particleMesh; // Return the 3D mesh
            }

            // Function to create and animate a DOM-based particle (e.g., for musical notes)
            function createDOMParticle(emoji, worldPosition) {
                const particleDiv = document.createElement('div');
                particleDiv.className = `animated-particle musical-note`; 
                particleDiv.textContent = emoji;
                
                const vector = worldPosition.clone();
                vector.project(camera);

                const container = document.getElementById('threejs-container');
                const canvasRect = container.getBoundingClientRect();

                const x = (vector.x * 0.5 + 0.5) * canvasRect.width + canvasRect.left;
                const y = (-vector.y * 0.5 + 0.5) * canvasRect.height + canvasRect.top;

                particleDiv.style.left = `${x}px`;
                particleDiv.style.top = `${y}px`;

                const xEnd = (Math.random() - 0.5) * 200 + 'px';
                const yEnd = (Math.random() * -100 - 150) + 'px';
                const duration = (Math.random() * 2 + 3) + 's';
                const rotationDuration = (Math.random() * 5 + 3) + 's';

                particleDiv.style.setProperty('--x-end', xEnd);
                particleDiv.style.setProperty('--y-end', yEnd);
                particleDiv.style.setProperty('--duration', duration);
                particleDiv.style.setProperty('--rotate-duration', rotationDuration);
                particleDiv.style.setProperty('--animation-name', 'floatAndFadeNote'); 

                document.body.appendChild(particleDiv);
                
                setTimeout(() => {
                    particleDiv.style.opacity = 1;
                }, 10); 

                setTimeout(() => {
                    particleDiv.remove();
                }, PARTICLE_LIFESPAN);
                // No need to push to a global array for DOM particles, as they self-remove effectively.
            }

            // Function to show Three.js related toast messages
            function showThreeJSToast(message, duration = 2000) {
                const toast = document.getElementById('three-js-feedback-toast');
                const toastMessage = document.getElementById('three-toast-message');
                toastMessage.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }

            // Function to smoothly animate camera to a new position and lookAt target using GSAP
            function animateCameraTo(newPosition, newLookAt, duration = 1.5) {
                return new Promise(resolve => {
                    gsap.to(camera.position, {
                        x: newPosition.x,
                        y: newPosition.y,
                        z: newPosition.z,
                        duration: duration,
                        ease: "power2.inOut",
                        onUpdate: function() {
                            camera.lookAt(newLookAt);
                        },
                        onComplete: resolve 
                    });
                });
            }

            // Three.js Initialization
            function initThreeJS() {
                const container = document.getElementById('threejs-container');
                const canvas = document.getElementById('three-canvas');

                // Scene
                scene = new THREE.Scene();
                
                // Camera
                camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(0, 5, 15); // Initial overview position
                camera.lookAt(0, 2, 0); // Look slightly above the base

                // Renderer
                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true }); 
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true; 
                renderer.shadowMap.type = THREE.PCFSoftShadowMap; 

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); 
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6); 
                directionalLight.position.set(5, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 1024;
                directionalLight.shadow.mapSize.height = 1024;
                directionalLight.shadow.camera.near = 0.5;
                directionalLight.shadow.camera.far = 50;
                directionalLight.shadow.camera.left = -10;
                directionalLight.shadow.camera.right = 10;
                directionalLight.shadow.camera.top = 10;
                directionalLight.shadow.camera.bottom = -10;
                scene.add(directionalLight);

                const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
                directionalLight2.position.set(-5, 5, -5);
                scene.add(directionalLight2);


                // --- Create Coffee Machine Geometry ---
                const machineGroup = new THREE.Group();

                // Base
                const baseGeometry = new THREE.BoxGeometry(4, 0.5, 3);
                const baseMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.2 });
                const base = new THREE.Mesh(baseGeometry, baseMaterial);
                base.position.set(0, 0.25, 0);
                base.castShadow = true;
                base.receiveShadow = true;
                machineGroup.add(base);

                // Main Body
                const bodyGeometry = new THREE.BoxGeometry(3.5, 4, 2.5);
                const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.9, roughness: 0.1 });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.set(0, 2.5, 0.25);
                body.castShadow = true;
                body.receiveShadow = true;
                machineGroup.add(body);

                // Water Tank (Transparent) - Left side
                const tankGeometry = new THREE.BoxGeometry(1.2, 3, 1);
                const tankMaterial = new THREE.MeshStandardMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.6, roughness: 0.3 });
                const waterTank = new THREE.Mesh(tankGeometry, tankMaterial);
                waterTank.position.set(-1.8, 2.5, -1); 
                waterTank.castShadow = true;
                waterTank.receiveShadow = false; 
                machineGroup.add(waterTank);

                // Grinder Hopper (Top) - Right side
                const hopperGeometry = new THREE.CylinderGeometry(0.8, 0.6, 1, 32);
                const hopperMaterial = new THREE.MeshStandardMaterial({ color: 0x999999, metalness: 0.7, roughness: 0.3 });
                hopperMesh = new THREE.Mesh(hopperGeometry, hopperMaterial); 
                hopperMesh.position.set(1.8, 4.75, 0); 
                hopperMesh.castShadow = true;
                hopperMesh.receiveShadow = true;
                machineGroup.add(hopperMesh);

                // Grinder (inside the body, below hopper)
                const grinderCylinderGeometry = new THREE.CylinderGeometry(0.6, 0.6, 1, 32);
                const grinderMaterial = new THREE.MeshStandardMaterial({ color: 0x777777, metalness: 0.9, roughness: 0.1 });
                grinderMesh = new THREE.Mesh(grinderCylinderGeometry, grinderMaterial); 
                grinderMesh.position.set(1.8, 3.5, 0); 
                grinderMesh.castShadow = true;
                grinderMesh.receiveShadow = true;
                machineGroup.add(grinderMesh);

                // Filter Station (center-front)
                const filterGeometry = new THREE.ConeGeometry(0.7, 0.5, 32);
                const filterMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.8, roughness: 0.2 });
                filterStationMesh = new THREE.Mesh(filterGeometry, filterMaterial); 
                filterStationMesh.position.set(0, 2.0, 1.2); 
                filterStationMesh.castShadow = true;
                filterStationMesh.receiveShadow = true;
                machineGroup.add(filterStationMesh);


                // Coffee Spout
                const spoutGeometry = new THREE.CylinderGeometry(0.1, 0.2, 0.5, 16);
                const spoutMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.9, roughness: 0.1 });
                spoutMesh = new THREE.Mesh(spoutGeometry, spoutMaterial); /* Stored as spoutMesh */
                spoutMesh.rotation.z = Math.PI / 2; 
                spoutMesh.position.set(0, 1.0, 1.8); 
                spoutMesh.castShadow = true;
                spoutMesh.receiveShadow = true;
                machineGroup.add(spoutMesh);

                // Drip Tray
                const dripTrayGeometry = new THREE.BoxGeometry(2.5, 0.1, 1.5);
                const dripTrayMaterial = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.7, roughness: 0.3 });
                const dripTray = new THREE.Mesh(dripTrayGeometry, dripTrayMaterial);
                dripTray.position.set(0, 0.55, 1.3); 
                dripTray.castShadow = true;
                dripTray.receiveShadow = true;
                machineGroup.add(dripTray);

                // Coffee Cup Placeholder
                const cupBodyGeometry = new THREE.CylinderGeometry(0.5, 0.6, 1, 32);
                const cupMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5 });
                cupMesh = new THREE.Mesh(cupBodyGeometry, cupMaterial); 
                cupMesh.position.set(0, 1.1, 1.3); 
                cupMesh.castShadow = true;
                cupMesh.receiveShadow = true;
                machineGroup.add(cupMesh);

                // Coffee Liquid inside the cup (initially hidden)
                const liquidGeometry = new THREE.CylinderGeometry(0.45, 0.55, 0.01, 32); 
                const liquidMaterial = new THREE.MeshStandardMaterial({ color: 0x6F4E37, transparent: true, opacity: 0.0 });
                liquidMesh = new THREE.Mesh(liquidGeometry, liquidMaterial);
                liquidMesh.position.set(0, 0.8 + 0.005, 1.3); 
                machineGroup.add(liquidMesh);

                // Coffee Liquid Stream (initially hidden)
                // Diameter from spout (0.1) to top of liquid in cup (0.45)
                liquidStreamGeometry = new THREE.CylinderGeometry(0.1, 0.4, 0.01, 8); // Thin cylinder, wider at bottom
                const liquidStreamMaterial = new THREE.MeshStandardMaterial({ color: 0x6F4E37, transparent: true, opacity: 0.0, roughness: 0.1 });
                liquidStreamMesh = new THREE.Mesh(liquidStreamGeometry, liquidStreamMaterial);
                liquidStreamMesh.position.set(0, 1.5, 1.8); // Position it just below the spout
                liquidStreamMesh.visible = false; // Initially invisible
                machineGroup.add(liquidStreamMesh);


                // Add machine group to the scene
                machineGroup.position.y = -0.5; 
                scene.add(machineGroup);
                coffeeMachine = machineGroup; 


                // Plane for shadows
                const planeGeometry = new THREE.PlaneGeometry(20, 20);
                const planeMaterial = new THREE.MeshStandardMaterial({ color: 0xdddddd, roughness: 0.8, metalness: 0.2 });
                const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                plane.rotation.x = -Math.PI / 2;
                plane.position.y = 0;
                plane.receiveShadow = true;
                scene.add(plane);


                // Mouse interaction for camera control (Orbit Control like)
                let isDragging = false;
                let previousMousePosition = { x: 0, y: 0 };
                const center = new THREE.Vector3(0, 2, 0); 
                let orbitRadius = camera.position.distanceTo(center); 
                let spherical = new THREE.Spherical().setFromCartesianCoords(
                    camera.position.x - center.x, 
                    camera.position.y - center.y, 
                    camera.position.z - center.z
                );

                canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                    e.preventDefault();
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    const rotationSpeed = 0.005;

                    spherical.phi -= deltaY * rotationSpeed; 
                    spherical.theta -= deltaX * rotationSpeed; 

                    spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));

                    camera.position.setFromSpherical(spherical).add(center);
                    camera.lookAt(center);

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                });

                canvas.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                canvas.addEventListener('mouseleave', () => { 
                    isDragging = false;
                });


                // Handle window resize
                window.addEventListener('resize', () => {
                    const newWidth = container.clientWidth;
                    const newHeight = container.clientHeight;
                    camera.aspect = newWidth / newHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(newWidth, newHeight);
                });

                // Animation Loop
                function animate() {
                    requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                }
                animate(); // Start the animation loop
            }

            // Function to handle adding beans
            function addBeans() {
                if (currentBrewStep === 0) {
                    showThreeJSToast("咖啡豆已投入料斗。");
                    // Animate camera to focus on the hopper
                    animateCameraTo(new THREE.Vector3(1.8, 5.5, 5), hopperMesh.position, 1);
                    
                    // Release 3D coffee bean particles after camera moves slightly
                    setTimeout(() => {
                        for(let i = 0; i < 15; i++) { // More beans for visibility
                            setTimeout(() => {
                                createThreeJSParticle('coffee_bean', new THREE.Vector3(1.8 + (Math.random()-0.5)*0.3, 5.25 + (Math.random()-0.5)*0.3, (Math.random()-0.5)*0.3)); 
                            }, i * 50); // Faster consecutive drops
                        }
                    }, 500); // Delay particle release for visual effect

                    currentBrewStep = 1;
                    document.getElementById('btn-add-beans').disabled = true;
                    document.getElementById('btn-start-grinding').disabled = false;
                } else {
                    showThreeJSToast("請先重置咖啡機。", 3000);
                }
            }

            // Function to handle grinding
            function startGrinding() {
                if (currentBrewStep === 1) {
                    showThreeJSToast("咖啡豆正在研磨中...");
                    animateCameraTo(new THREE.Vector3(1.8, 3.5, 5), grinderMesh.position, 1);
                    
                    // Animate grinder rotation (simulate grinding)
                    gsap.to(grinderMesh.rotation, {
                        y: "+=" + Math.PI * 4, // Increased rotation for visual "tumbling" feel
                        duration: 2,
                        ease: "linear",
                        repeat: 0
                    });

                    // Simulate beans entering the grinder from the hopper (few more 3D beans)
                    setTimeout(() => {
                         for(let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                createThreeJSParticle('coffee_bean', new THREE.Vector3(1.8 + (Math.random()-0.5)*0.2, 4.0 + (Math.random()-0.5)*0.1, (Math.random()-0.5)*0.2)); 
                            }, i * 100);
                        }
                    }, 500); // Start dropping into grinder shortly after camera move

                    // Release ground coffee powder particles from grinder exit after some delay
                    setTimeout(() => {
                         for(let i = 0; i < 30; i++) { // More powder particles
                            setTimeout(() => {
                                createThreeJSParticle('coffee_powder', new THREE.Vector3(0 + (Math.random()-0.5)*0.2, 1.8 + (Math.random()-0.5)*0.1, 1.2 + (Math.random()-0.5)*0.1)); // Position near filter station/cup
                            }, i * 50);
                        }
                    }, 1500); // Delay particle release to after grinding starts

                    currentBrewStep = 2;
                    document.getElementById('btn-start-grinding').disabled = true;
                    document.getElementById('btn-start-brewing').disabled = false;
                } else if (currentBrewStep === 0) {
                    showThreeJSToast("請先投入咖啡豆。", 3000);
                } else if (currentBrewStep === 1) {
                    showThreeJSToast("請先研磨咖啡豆。", 3000);
                } else {
                    showThreeJSToast("請先重置咖啡機。", 3000);
                }
            }

            // Function to handle brewing
            async function startBrewing() { 
                if (currentBrewStep === 2) {
                    showThreeJSToast("正在為您沖泡香醇咖啡...");
                    // Animate camera to filter station, then to cup
                    await animateCameraTo(new THREE.Vector3(0, 2.5, 4), filterStationMesh.position, 1.0); 
                    await animateCameraTo(new THREE.Vector3(0, 1.8, 4), cupMesh.position, 1.0); 

                    // Phase 2: Start liquid stream animation
                    liquidStreamMesh.visible = true;
                    gsap.to(liquidStreamMesh.material, { opacity: 0.8, duration: 0.3 }); // Fade in stream

                    // Simulate liquid flowing down into the cup - initial scale up
                    gsap.to(liquidStreamMesh.scale, {
                        y: 1.0, 
                        duration: 0.5,
                        ease: "power1.out"
                    });


                    const maxFillHeight = 0.8; 
                    const fillDuration = 3000; 

                    // GSAP animation for liquid in cup
                    gsap.to(liquidMesh.scale, {
                        y: maxFillHeight,
                        duration: fillDuration / 1000,
                        ease: "power1.inOut"
                    });
                    gsap.to(liquidMesh.material, {
                        opacity: 1.0,
                        duration: fillDuration / 1000,
                        ease: "power1.inOut"
                    });
                    // Position adjustment for liquid in cup
                    gsap.to(liquidMesh.position, {
                        y: 0.8 + (liquidMesh.geometry.parameters.height * maxFillHeight) / 2,
                        duration: fillDuration / 1000,
                        ease: "power1.inOut",
                        onUpdate: function() {
                            // Dynamically adjust liquid stream length as cup fills
                            const currentLiquidSurfaceY = liquidMesh.position.y + (liquidMesh.geometry.parameters.height * liquidMesh.scale.y) / 2;
                            const spoutY = spoutMesh.position.y; 
                            const streamLength = spoutY - currentLiquidSurfaceY;
                            
                            // Set stream's length and position it between spout and liquid surface
                            liquidStreamMesh.scale.y = Math.max(0.01, streamLength / liquidStreamGeometry.parameters.height); // Ensure min length
                            liquidStreamMesh.position.y = (spoutY + currentLiquidSurfaceY) / 2;
                        },
                        onComplete: () => {
                            showThreeJSToast("咖啡沖泡完成！請享用。");
                            // Fade out and hide liquid stream
                            gsap.to(liquidStreamMesh.material, { opacity: 0, duration: 0.5, onComplete: () => { liquidStreamMesh.visible = false; }});

                            for(let i = 0; i < 5; i++) {
                                setTimeout(() => {
                                    createDOMParticle(MUSICAL_NOTES_EMOJI, new THREE.Vector3(0 + (Math.random()-0.5)*0.2, 1.8 + (Math.random()-0.5)*0.2, 1.3 + (Math.random()-0.5)*0.2)); 
                                }, i * 150);
                            }
                        }
                    });

                    currentBrewStep = 3;
                    document.getElementById('btn-start-brewing').disabled = true;
                } else if (currentBrewStep === 0) {
                    showThreeJSToast("請先投入咖啡豆。", 3000);
                } else if (currentBrewStep === 1) {
                    showThreeJSToast("請先研磨咖啡豆。", 3000);
                } else {
                    showThreeJSToast("請先重置咖啡機。", 3000);
                }
            }

            // Function to reset the machine
            function resetMachine() {
                showThreeJSToast("咖啡機已重置，請重新開始。");
                currentBrewStep = 0;
                document.getElementById('btn-add-beans').disabled = false;
                document.getElementById('btn-start-grinding').disabled = true;
                document.getElementById('btn-start-brewing').disabled = true;

                // Reset liquid in cup using GSAP
                gsap.to(liquidMesh.scale, {
                    y: 0.01,
                    duration: 0.5,
                    ease: "power1.inOut"
                });
                gsap.to(liquidMesh.material, {
                    opacity: 0,
                    duration: 0.5,
                    ease: "power1.inOut"
                });
                gsap.to(liquidMesh.position, {
                    y: 0.8 + 0.005,
                    duration: 0.5,
                    ease: "power1.inOut"
                });

                // Hide liquid stream immediately
                if (liquidStreamMesh) {
                    gsap.to(liquidStreamMesh.material, { opacity: 0, duration: 0.2, onComplete: () => { liquidStreamMesh.visible = false; }});
                    liquidStreamMesh.scale.y = 0.01; // Reset scale
                    liquidStreamMesh.position.y = 1.5; // Reset position
                }

                // Animate camera back to initial overview position
                animateCameraTo(new THREE.Vector3(0, 5, 15), new THREE.Vector3(0, 2, 0), 1.5);

                // Remove any lingering 3D particles
                activeParticles.forEach(p => { // Corrected array name
                    if (p.parent) scene.remove(p); 
                });
                activeParticles = []; // Corrected array name

                // Also remove any remaining DOM particles (musical notes)
                document.querySelectorAll('.animated-particle').forEach(p => p.remove());
            }

            // Function to simulate brewing process (for Flavor Guide section)
            function simulateBrewingProcess() {
                const brewingVisualizer = document.getElementById('brewing-visualizer');
                const brewingLiquid = brewingVisualizer.querySelector('.brewing-liquid');

                // Activate brewing visualizer
                brewingVisualizer.classList.add('active');
                brewingLiquid.style.height = '0%'; // Reset liquid level

                // Start filling animation
                setTimeout(() => {
                    brewingLiquid.classList.add('fill');
                }, 100); // Small delay to allow CSS reset to apply

                // Deactivate after a delay
                setTimeout(() => {
                    brewingVisualizer.classList.remove('active');
                    brewingLiquid.classList.remove('fill');
                }, 2000); // Total animation time (1.5s fill + 0.5s buffer)
            }


            // --- END Three.js Setup ---

            // Initialize or update Radar Chart
            window.renderFlavorRadarChart = function(data) { // Expose to window for external calls
                const ctx = document.getElementById('flavorRadarChart').getContext('2d');
                if (window.flavorRadarChart) {
                    window.flavorRadarChart.destroy(); // Destroy existing chart if it exists
                }

                // Ensure data.profile is an array of 5 numbers, fill with 2.5 if not
                const profileData = Array.isArray(data.profile) && data.profile.length === 5
                                    ? data.profile
                                    : [2.5, 2.5, 2.5, 2.5, 2.5]; // Default if missing or malformed

                // Get computed style for CSS variable
                const computedStyle = getComputedStyle(document.body);
                const secondaryColor = computedStyle.getPropertyValue('--color-secondary').trim();

                window.flavorRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['苦味', '酸度', '醇厚度', '花果香', '堅果/巧克力'],
                        datasets: [{
                            label: data.name,
                            data: profileData, // Use the 0-5 scaled data directly
                            backgroundColor: 'rgba(181, 136, 99, 0.6)', // var(--color-primary) with opacity
                            borderColor: 'rgba(181, 136, 99, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(181, 136, 99, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(181, 136, 99, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                pointLabels: {
                                    font: {
                                        size: 14,
                                        family: "'Noto Sans TC', sans-serif",
                                        weight: 'bold'
                                    },
                                    color: secondaryColor,
                                },
                                ticks: {
                                    display: true, // Show ticks for 0-5 scale
                                    beginAtZero: true,
                                    max: 5, // Set max to 5
                                    stepSize: 1, // Show ticks for 0, 1, 2, 3, 4, 5
                                    color: secondaryColor // Tick label color
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.r.toFixed(1); // Display with one decimal place
                                        return label;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // Function to render coffee bean details in Flavor Guide
            window.renderBeanDetails = function(bean) { // Expose to window
                document.getElementById('detail-name').textContent = bean.name || 'N/A';
                document.getElementById('detail-country').textContent = bean.country || 'N/A';
                document.getElementById('detail-variety').textContent = bean.variety || 'N/A';
                document.getElementById('detail-processing').textContent = bean.processing || 'N/A';
                document.getElementById('detail-altitude').textContent = bean.altitude || 'N/A';
                document.getElementById('detail-roast').textContent = bean.roast || 'N/A';
                document.getElementById('detail-weight').textContent = bean.weight || 'N/A';
                document.getElementById('detail-expiry').textContent = bean.expiry || 'N/A';
                document.getElementById('detail-flavor').textContent = bean.flavor || 'N/A';
                document.getElementById('detail-farm-or-station').textContent = bean.farm_or_station || 'N/A';
                document.getElementById('detail-price').textContent = bean.price !== undefined ? bean.price : 'N/A';
                document.getElementById('detail-stock').textContent = bean.stock !== undefined ? bean.stock + ' 包' : 'N/A';

                const stockStatusElement = document.getElementById('stock-status');
                stockStatusElement.className = 'stock-indicator'; // Reset classes

                if (bean.stock > 50) {
                    stockStatusElement.textContent = '庫存充足';
                    stockStatusElement.classList.add('stock-in-stock');
                } else if (bean.stock > 0) {
                    stockStatusElement.textContent = '庫存緊張';
                    stockStatusElement.classList.add('stock-low-stock');
                } else {
                    stockStatusElement.textContent = '已售罄';
                    stockStatusElement.classList.add('stock-out-of-stock');
                }

                document.getElementById('lifestyle-suggestion').innerHTML = `
                    <h4 class="font-bold font-serif text-lg text-accent mb-2">生活提案</h4>
                    <p>${bean.lifestyle || '請先選擇一款咖啡豆，我們會為您推薦最適合的品飲時刻與搭配。'}</p>
                `;
            }

            // Handles changes in the flavor select dropdown
            function handleFlavorSelectChange(event) {
                const selectedBeanId = event.target.value;
                const beanDetailsDisplay = document.getElementById('bean-details-display');

                if (selectedBeanId) {
                    const selectedBean = window.products.find(bean => bean.id === selectedBeanId);
                    if (selectedBean) {
                        window.renderFlavorRadarChart(selectedBean);
                        window.renderBeanDetails(selectedBean);
                        beanDetailsDisplay.classList.add('is-visible');
                        simulateBrewingProcess();
                    }
                } else {
                    if (window.flavorRadarChart) {
                        window.flavorRadarChart.destroy();
                        window.flavorRadarChart = null;
                    }
                    // Clear bean details and lifestyle suggestion
                    document.getElementById('detail-name').textContent = '';
                    document.getElementById('detail-country').textContent = '';
                    document.getElementById('detail-variety').textContent = '';
                    document.getElementById('detail-processing').textContent = '';
                    document.getElementById('detail-altitude').textContent = '';
                    document.getElementById('detail-roast').textContent = '';
                    document.getElementById('detail-weight').textContent = '';
                    document.getElementById('detail-expiry').textContent = '';
                    document.getElementById('detail-flavor').textContent = '';
                    document.getElementById('detail-farm-or-station').textContent = '';
                    document.getElementById('detail-price').textContent = '';
                    document.getElementById('detail-stock').textContent = '';
                    document.getElementById('stock-status').className = 'stock-indicator';
                    document.getElementById('stock-status').textContent = '';
                    document.getElementById('lifestyle-suggestion').innerHTML = `
                        <h4 class="font-bold font-serif text-lg text-accent mb-2">生活提案</h4>
                        <p>請先選擇一款咖啡豆，我們會為您推薦最適合的品飲時刻與搭配。</p>
                    `;
                    beanDetailsDisplay.classList.remove('is-visible');
                }
            }


            // Listen for real-time updates to the coffeeProducts collection (Frontend)
            window.listenToProducts = function() {
                // Ensure Firebase is initialized before attempting to listen
                if (!window.db || !window.productsCollectionRef) {
                    console.error("Firestore not initialized for frontend product listening.");
                    return;
                }

                const q = window.queryFirestore(window.productsCollectionRef, window.orderByFirestore('name'));

                window.onSnapshotFirestore(q, (snapshot) => {
                    window.products = [];
                    snapshot.forEach((doc) => {
                        const productData = doc.data();
                        // Convert profile values from 0-100 to 0-5 scale for frontend display
                        if (Array.isArray(productData.profile) && productData.profile.length === 5) {
                            productData.profile = productData.profile.map(value => value / 20);
                        } else {
                            productData.profile = [2.5, 2.5, 2.5, 2.5, 2.5]; // Default to 2.5 on 0-5 scale
                        }
                        window.products.push({ id: doc.id, ...productData });
                    });
                    console.log("[Firebase] Frontend products updated:", window.products.length);
                    window.renderFrontendProductsDisplay();

                    // Handle initial selection for Flavor Guide dropdown
                    const flavorSelect = document.getElementById('flavor-select');
                    if (flavorSelect && window.products.length > 0) {
                        const currentSelectedId = flavorSelect.value;
                        const previouslySelectedExists = window.products.some(p => p.id === currentSelectedId);

                        if (!currentSelectedId || !previouslySelectedExists) {
                            // Select the first product if nothing is selected or previously selected doesn't exist
                            const defaultBean = window.products[0];
                            flavorSelect.value = defaultBean.id;
                            handleFlavorSelectChange({ target: flavorSelect });
                        } else {
                            // Re-render details for the currently selected product if it still exists
                            const selectedBean = window.products.find(bean => bean.id === currentSelectedId);
                            if (selectedBean) {
                                window.renderFlavorRadarChart(selectedBean);
                                window.renderBeanDetails(selectedBean);
                            }
                        }
                        document.getElementById('bean-details-display').classList.add('is-visible');
                    } else if (flavorSelect && window.products.length === 0) {
                        // No products available, clear selection and details
                        flavorSelect.value = '';
                        handleFlavorSelectChange({ target: flavorSelect });
                    }

                }, (error) => {
                    console.error("[Firebase] Error listening to products on frontend:", error);
                    window.showFrontMessageModal('資料載入錯誤', `無法載入咖啡豆資料：${error.message}`, 'error');
                });
            };

            // Renders products in the frontend "Our Premium Coffee Beans" section
            window.renderFrontendProductsDisplay = function() { // Renamed to avoid confusion with admin render
                const ourBeansContainer = document.querySelector('#our-beans .grid');
                if (ourBeansContainer) {
                    ourBeansContainer.innerHTML = ''; // Clear existing content
                    if (window.products.length === 0) {
                        ourBeansContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">目前沒有咖啡豆品項可顯示。</p>';
                        return;
                    }
                    window.products.forEach((product, index) => {
                        const beanCard = `
                            <div class="card p-4 fade-in-up bean-card" style="transition-delay: ${index * 100}ms;">
                                <img src="${product.image || 'https://placehold.co/200x120/e0e0e0/3f2e2e?text=No+Image'}" onerror="this.onerror=null;this.src='https://placehold.co/200x120/e0e0e0/3f2e2e?text=Image+Error';" alt="${product.name}" class="w-full h-48 object-cover rounded-md mb-4">
                                <div class="bean-overlay">
                                    <p>${product.name}: ${product.flavor || 'N/A'}</p>
                                </div>
                                <h3 class="text-xl font-serif mb-2">${product.name}</h3>
                                <p class="text-gray-600 text-sm">售價：NT$${product.price !== undefined ? product.price : 'N/A'}</p>
                                <p class="text-gray-600 text-sm">庫存：
                                    <span class="stock-indicator ${product.stock > 5 ? 'stock-in-stock' : (product.stock > 0 ? 'stock-low-stock' : 'stock-out-of-stock')}">
                                        ${product.stock > 0 ? (product.stock <= 5 ? '低庫存' : '有庫存') : '已售罄'}
                                    </span>
                                </p>
                            </div>
                        `;
                        ourBeansContainer.innerHTML += beanCard;
                    });
                }

                // Update "Flavor Exploration Guide" dropdown
                const flavorSelect = document.getElementById('flavor-select');
                if (flavorSelect) {
                    flavorSelect.innerHTML = '<option value="">請選擇一款咖啡豆</option>';
                    window.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        flavorSelect.appendChild(option);
                    });

                    // Re-add event listener to prevent multiple bindings
                    flavorSelect.removeEventListener('change', handleFlavorSelectChange);
                    flavorSelect.addEventListener('change', handleFlavorSelectChange);
                }
            };

            // Function to show coffee fact toast (moved to global scope for interval)
            const coffeeFacts = [
                "一杯完美的咖啡，98% 是水，所以水的品質非常重要！",
                "咖啡是世界上第二大交易商品，僅次於石油。",
                "「卡布奇諾」的名字來源於方濟各會修士的帽子顏色。",
                "咖啡樹需要大約3-5年的時間才能結果。",
                "世界上最昂貴的咖啡是麝香貓咖啡，但其生產方式存在爭議。",
                "喝咖啡的最佳時間是上午 9:30 到 11:30，因為此時皮質醇水平較低。",
                "咖啡豆實際上是咖啡果實的種子，而不是真正的豆子。"
            ];
            window.showCoffeeFactToast = function(message, duration = 3000) {
                const toast = document.getElementById('coffee-fact-toast');
                document.getElementById('toast-message').textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            };


            // Event Listeners for DOM elements
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[DEBUG] DOM Content Loaded. Initializing.');

                // Initialize Three.js scene
                initThreeJS();

                // Button listeners for Three.js machine simulation
                document.getElementById('btn-add-beans').addEventListener('click', addBeans);
                document.getElementById('btn-start-grinding').addEventListener('click', startGrinding);
                document.getElementById('btn-start-brewing').addEventListener('click', startBrewing);
                document.getElementById('btn-reset-machine').addEventListener('click', resetMachine);


                // Flavor Select Change Listener
                const flavorSelect = document.getElementById('flavor-select');
                if (flavorSelect) {
                    // Initial setup (will be overridden by Firestore listener but good fallback)
                    // The Firestore listener will manage the data and trigger renderFrontendProductsDisplay
                    // which in turn re-attaches handleFlavorSelectChange.
                    flavorSelect.addEventListener('change', handleFlavorSelectChange);
                } else {
                    console.error('[ERROR] Flavor select element not found!');
                }

                // Refresh Coffee Button Listener (now triggers frontend re-render from current Firestore data)
                const refreshCoffeeBtn = document.getElementById('refresh-coffee-btn');
                if (refreshCoffeeBtn) {
                    refreshCoffeeBtn.addEventListener('click', () => {
                        console.log('[DEBUG] Refresh Coffee button clicked. Forcing frontend re-render.');
                        window.renderFrontendProductsDisplay(); // Re-render from the already fetched window.products
                        showFrontMessageModal('更新成功', '咖啡豆資訊已重新整理！', 'success');
                    });
                } else {
                    console.error('[ERROR] Refresh coffee button not found!');
                }

                // Contact Form Submission
                const contactForm = document.getElementById('contact-form');
                if (contactForm) {
                    contactForm.addEventListener('submit', function(e) {
                        e.preventDefault(); // Prevent default form submission

                        const name = document.getElementById('name').value;
                        const email = document.getElementById('email').value;
                        const message = document.getElementById('message').value;

                        if (name && email && message) {
                            const recipientEmail = 'melodybean33427@gmail.com';
                            // Define a clear subject for the email
                            const subject = encodeURIComponent('來自 Melody Bean 網站的訊息');
                            // Format the body with placeholders replaced by actual values
                            const body = encodeURIComponent(`姓名：${name}\n電子郵件：${email}\n訊息：${message}`);

                            // Construct the generic Gmail compose URL
                            const gmailComposeUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipientEmail}&su=${subject}&body=${body}`;

                            // Open in a new tab
                            window.open(gmailComposeUrl, '_blank');

                            // Show a modal to inform the user about the redirection
                            showFrontMessageModal('即將跳轉至 Gmail', '您的瀏覽器將開啟 Gmail 郵件撰寫頁面，訊息內容已為您填寫完成，請確認後手動點擊發送。', 'info');
                            
                            // Optionally, reset the form after a short delay
                            setTimeout(() => {
                                contactForm.reset();
                            }, 500); 

                        } else {
                            showFrontMessageModal('錯誤', '請填寫所有必填欄位。', 'error');
                        }
                    });
                } else {
                    console.error('[ERROR] Contact form not found!');
                }

                // Accordion (FAQ) Functionality
                document.querySelectorAll('.accordion-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const content = button.nextElementSibling;
                        button.classList.toggle('open');
                        if (button.classList.contains('open')) {
                            content.style.maxHeight = content.scrollHeight + 'px';
                        } else {
                            content.style.maxHeight = null;
                        }
                    });
                });
                console.log('[DEBUG] Accordion functionality set up.');

                // Knowledge Section "閱讀更多" Links
                document.querySelectorAll('.more-info-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const knowledgeId = this.dataset.knowledgeId;
                        const article = knowledgeArticles[knowledgeId];
                        if (article) {
                            showFrontMessageModal(article.title, article.content, 'info');
                        } else {
                            showFrontMessageModal('錯誤', '找不到此文章內容。', 'error');
                        }
                    });
                });
                console.log('[DEBUG] Knowledge "閱讀更多" links set up.');

                // Scroll Animation Observer
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            // Add pulsing animation to section titles when they become visible
                            if (entry.target.classList.contains('animate-pulse-on-scroll')) {
                                entry.target.classList.add('is-pulsing');
                            }
                            // Only unobserve if it's a one-time animation trigger
                            if (!entry.target.classList.contains('section-title')) { // Keep section titles observed for continuous pulse if desired
                                observer.unobserve(entry.target);
                            }
                        } else {
                            // Optional: remove pulsing when not visible, if animation should stop
                            if (entry.target.classList.contains('animate-pulse-on-scroll')) {
                                entry.target.classList.remove('is-pulsing');
                            }
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('.fade-in-up').forEach(el => {
                    observer.observe(el);
                });
                // Observe section titles for pulsing animation
                document.querySelectorAll('.section-title.animate-pulse-on-scroll').forEach(el => {
                    observer.observe(el);
                });

                console.log('[DEBUG] Scroll animation observer set up.');

                // Back to Top Button
                const backToTopBtn = document.getElementById('back-to-top-btn');
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300) { // Show button after scrolling down 300px
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                });

                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
                console.log('[DEBUG] Back to top button set up.');

                // Home section scroll down button
                const scrollDownBtn = document.getElementById('scroll-down-btn');
                if (scrollDownBtn) {
                    scrollDownBtn.addEventListener('click', () => {
                        const targetSection = document.getElementById('coffee-machine-display');
                        if (targetSection) {
                            targetSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                }

                // Initial load of all data and render on page load
                // This is now handled by the Firebase listener in the module script.
                // window.loadAndRenderAllData(); // This function is no longer needed here.


                // Coffee Grounds Flip Card functionality
                document.querySelectorAll('.flip-card').forEach(card => {
                    card.addEventListener('click', () => {
                        card.classList.toggle('flipped');
                    });
                });
                console.log('[DEBUG] Coffee grounds flip card functionality set up.');

                // Coffee Fact Toast (Initial random display)
                const coffeeFacts = [
                    "一杯完美的咖啡，98% 是水，所以水的品質非常重要！",
                    "咖啡是世界上第二大交易商品，僅次於石油。",
                    "「卡布奇諾」的名字來源於方濟各會修士的帽子顏色。",
                    "咖啡樹需要大約3-5年的時間才能結果。",
                    "世界上最昂貴的咖啡是麝香貓咖啡，但其生產方式存在爭議。",
                    "喝咖啡的最佳時間是上午 9:30 到 11:30，因為此時皮質醇水平較低。",
                    "咖啡豆實際上是咖啡果實的種子，而不是真正的豆子。"
                ];
                function showRandomCoffeeFact() {
                    const randomFact = coffeeFacts[Math.floor(Math.random() * coffeeFacts.length)];
                    showCoffeeFactToast(randomFact, 5000); // Show for 5 seconds
                }
                // Show a random fact every 30-60 seconds
                setInterval(showRandomCoffeeFact, Math.random() * 30000 + 30000); // Between 30 and 60 seconds
                showRandomCoffeeFact(); // Show one on initial load
                console.log('[DEBUG] Coffee fact toast set up.');


                // Simulate page loading
                const loadingOverlay = document.getElementById('loading-overlay');
                // Temporarily show loading overlay for 1.5 seconds for demo
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    // Re-enable scrolling after loading
                    document.body.style.overflow = '';
                }, 1500); 

            }); // End DOMContentLoaded
        })(); // End IIFE
    </script>
</body>
</html>
